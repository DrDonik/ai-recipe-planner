---
name: Fix missingIngredients prompt rules and update tests
status: closed
created: 2026-02-24T14:48:09Z
updated: 2026-02-24T14:58:55Z
github: https://github.com/DrDonik/ai-recipe-planner/issues/165
depends_on: []
parallel: false
conflicts_with: []
---

# Task: Fix missingIngredients prompt rules and update tests

## Description

Rewrite rule 13 in `buildRecipePrompt()` to explicitly scope `missingIngredients` to the individual recipe, and add a new rule that defines the top-level `shoppingList` as the cross-recipe aggregate. Update `llm.test.ts` to assert the corrected rule text.

## Acceptance Criteria

- [ ] Rule 13 no longer contains "combine them in the `missingIngredients` array and total the amount needed"
- [ ] Rule 13 explicitly states that each recipe's `missingIngredients` lists only what that specific recipe needs, at that recipe's quantity
- [ ] A new rule (appended after rule 16) explicitly describes `shoppingList` as the aggregated cross-recipe list
- [ ] All existing tests in `llm.test.ts` pass without modification
- [ ] New/updated test assertions confirm the corrected rule 13 text is present
- [ ] New/updated test assertion confirms the new `shoppingList` rule text is present
- [ ] `npm run build` passes
- [ ] `npm test` passes

## Technical Details

**File to modify:** `src/services/llm.ts`

Current rule 13 (line ~157):
```
13. If the same ingredient is missing in different recipes, combine them in the "missingIngredients" array and total the amount needed.
```

Replace with:
```
13. Each recipe's "missingIngredients" must list only the ingredients that specific recipe requires to be purchased, at the amount needed for that recipe alone. Do not combine amounts across recipes in "missingIngredients".
```

New rule to append after rule 16:
```
17. The top-level "shoppingList" is the aggregated shopping list across all recipes. If the same ingredient is needed in multiple recipes, combine the totals here.
```

Note: existing rule 17 ("Return ONLY valid JSON…") becomes rule 18, and so on — renumber the remaining rules.

**File to modify:** `src/__tests__/services/llm.test.ts`

- Find existing test(s) that check rule text in the generated prompt (tests for `buildRecipePrompt()`).
- Add/update assertions:
  - Prompt does NOT contain the old ambiguous phrase: `"combine them in the"`
  - Prompt DOES contain the new per-recipe scoping phrase (e.g., `"that specific recipe"` or `"for that recipe alone"`)
  - Prompt DOES contain the new `shoppingList` aggregation rule text

## Dependencies

- None

## Effort Estimate

- Size: XS
- Hours: 1
- Parallel: false
