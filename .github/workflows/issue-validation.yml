name: Issue Validation

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to validate'
        required: true
        type: number

jobs:
  validate-issue:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get issue data
        id: issue
        uses: actions/github-script@v7
        with:
          script: |
            let issue;
            if (context.eventName === 'workflow_dispatch') {
              const { data } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ inputs.issue_number || 0 }}
              });
              issue = data;
            } else {
              issue = context.payload.issue;
            }
            core.setOutput('number', issue.number);
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            core.setOutput('author', issue.user.login);

      - name: Validate Issue with Claude
        id: validate
        uses: anthropics/claude-code-action@v1
        env:
          ISSUE_TITLE: ${{ steps.issue.outputs.title }}
          ISSUE_BODY: ${{ steps.issue.outputs.body }}
          ISSUE_AUTHOR: ${{ steps.issue.outputs.author }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: |
            --json-schema '{"type":"object","required":["valid","complexity","ux_impact","safe_to_auto_implement","summary","implementation_notes"],"properties":{"valid":{"type":"boolean","description":"Whether this is a valid issue"},"complexity":{"type":"string","enum":["easy","medium","hard"],"description":"Implementation complexity"},"ux_impact":{"type":"string","enum":["positive","neutral","breaking"],"description":"User experience impact"},"safe_to_auto_implement":{"type":"boolean","description":"Whether safe to auto-implement"},"summary":{"type":"string","description":"Brief summary of assessment"},"implementation_notes":{"type":"string","description":"Implementation notes if valid"}}}'
          prompt: |
            Analyze this GitHub issue and provide an assessment. Read the CLAUDE.md file first to understand the project.

            Issue Title: ${{ steps.issue.outputs.title }}
            Issue Body: ${{ steps.issue.outputs.body }}
            Issue Author: ${{ steps.issue.outputs.author }}

            Please evaluate:

            1. **Validity**: Is this a valid issue that addresses a real problem, bug, concern, or enhancement request?
               - Look for: clear description, reproducible problem, or reasonable feature request
               - Invalid examples: spam, unrelated to project, too vague to act on

            2. **Implementation Complexity**: How difficult would this be to implement?
               - Easy: Single file change, clear solution, no architectural changes
               - Medium: Multiple files, some design decisions needed
               - Hard: Architectural changes, major refactoring, or unclear solution

            3. **User Experience Impact**: How would this affect users?
               - Positive/Neutral: Improves UX or keeps it the same
               - Breaking: Changes existing behavior, removes features, or breaks backwards compatibility

            Set `safe_to_auto_implement` to `true` ONLY if ALL of these are true:
            - valid is true
            - complexity is "easy"
            - ux_impact is "positive" or "neutral"
            - The solution is clear and unlikely to cause problems

            Provide your assessment as structured output matching the JSON schema.

      - name: Parse Claude Response
        id: parse
        env:
          STRUCTURED_OUTPUT: ${{ steps.validate.outputs.structured_output }}
        uses: actions/github-script@v7
        with:
          script: |
            const structuredOutput = process.env.STRUCTURED_OUTPUT || '';
            console.log('Structured output length:', structuredOutput.length);
            console.log('Structured output preview:', structuredOutput.substring(0, 500));

            if (!structuredOutput) {
              console.log('No structured output received');
              core.setOutput('valid', 'false');
              core.setOutput('safe_to_auto_implement', 'false');
              return;
            }

            try {
              const assessment = JSON.parse(structuredOutput);
              console.log('Parsed assessment:', JSON.stringify(assessment));
              core.setOutput('valid', String(assessment.valid));
              core.setOutput('complexity', assessment.complexity || 'unknown');
              core.setOutput('ux_impact', assessment.ux_impact || 'unknown');
              core.setOutput('safe_to_auto_implement', String(assessment.safe_to_auto_implement));
              core.setOutput('summary', assessment.summary || '');
              core.setOutput('implementation_notes', assessment.implementation_notes || '');
            } catch (e) {
              console.log('Failed to parse structured output:', e);
              core.setOutput('valid', 'false');
              core.setOutput('safe_to_auto_implement', 'false');
            }

      - name: Add Assessment Labels
        uses: actions/github-script@v7
        with:
          script: |
            const valid = '${{ steps.parse.outputs.valid }}' === 'true';
            const complexity = '${{ steps.parse.outputs.complexity }}';
            const uxImpact = '${{ steps.parse.outputs.ux_impact }}';
            const safeToAutoImpl = '${{ steps.parse.outputs.safe_to_auto_implement }}' === 'true';

            const labels = [];

            if (valid) {
              labels.push('validated');
              labels.push(`complexity:${complexity}`);
              labels.push(`ux:${uxImpact}`);

              if (safeToAutoImpl) {
                labels.push('auto-implementable');
              }
            } else {
              labels.push('needs-clarification');
            }

            // Ensure labels exist before adding
            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label
                });
              } catch (e) {
                // Label doesn't exist, create it
                const colors = {
                  'validated': '0e8a16',
                  'needs-clarification': 'fbca04',
                  'complexity:easy': 'c5def5',
                  'complexity:medium': '1d76db',
                  'complexity:hard': 'd93f0b',
                  'ux:positive': '0e8a16',
                  'ux:neutral': 'c5def5',
                  'ux:breaking': 'd93f0b',
                  'auto-implementable': '5319e7'
                };
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label,
                  color: colors[label] || 'ededed'
                });
              }
            }

            const issueNumber = ${{ steps.issue.outputs.number }};
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: labels
            });

      - name: Post Assessment Comment
        env:
          SUMMARY: ${{ steps.parse.outputs.summary }}
          IMPL_NOTES: ${{ steps.parse.outputs.implementation_notes }}
        uses: actions/github-script@v7
        with:
          script: |
            const valid = '${{ steps.parse.outputs.valid }}' === 'true';
            const complexity = '${{ steps.parse.outputs.complexity }}';
            const uxImpact = '${{ steps.parse.outputs.ux_impact }}';
            const safeToAutoImpl = '${{ steps.parse.outputs.safe_to_auto_implement }}' === 'true';
            const summary = process.env.SUMMARY || '';
            const implNotes = process.env.IMPL_NOTES || '';
            const issueAuthor = '${{ steps.issue.outputs.author }}';
            const issueNumber = ${{ steps.issue.outputs.number }};
            const trustedActors = ['DrDonik'];
            const isTrustedActor = trustedActors.includes(issueAuthor);

            let comment = `## Issue Validation Assessment\n\n`;
            comment += `| Criterion | Result |\n`;
            comment += `|-----------|--------|\n`;
            comment += `| Valid Issue | ${valid ? '‚úÖ Yes' : '‚ùå No'} |\n`;
            comment += `| Complexity | ${complexity === 'easy' ? 'üü¢' : complexity === 'medium' ? 'üü°' : 'üî¥'} ${complexity} |\n`;
            comment += `| UX Impact | ${uxImpact === 'positive' ? 'üü¢' : uxImpact === 'neutral' ? 'üü°' : 'üî¥'} ${uxImpact} |\n`;
            comment += `| Safe to Auto-Implement | ${safeToAutoImpl ? '‚úÖ Yes' : '‚ùå No'} |\n\n`;

            if (summary) {
              comment += `**Summary:** ${summary}\n\n`;
            }

            if (implNotes && valid) {
              comment += `**Implementation Notes:** ${implNotes}\n\n`;
            }

            comment += `---\n\n`;

            if (safeToAutoImpl && isTrustedActor) {
              comment += `ü§ñ This issue has been automatically flagged for implementation by @claude.\n\n`;
              comment += `@claude Please implement the fix/enhancement described in this issue.`;
            } else if (safeToAutoImpl && !isTrustedActor) {
              comment += `‚ÑπÔ∏è This issue appears safe to auto-implement, but requires approval from a maintainer.\n`;
              comment += `Maintainers: Add the \`approved-for-auto-impl\` label or comment \`@claude\` to trigger implementation.`;
            } else if (valid) {
              comment += `‚ÑπÔ∏è This issue requires manual review before implementation.\n`;
              comment += `Maintainers: Comment \`@claude\` to request implementation when ready.`;
            } else {
              comment += `‚ö†Ô∏è This issue needs clarification before it can be addressed.\n`;
              comment += `Please provide more details about the problem or enhancement you're requesting.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: comment
            });
